from preprocessing.preprocessor import Preprocessor
from agent.orchestrator import AIAgent

def run_once():
    preproc = Preprocessor(ocr_lang="eng+chi_sim")
    agent = AIAgent()

    user_text = input("请输入你的问题：")
    preprocess_result = preproc.preprocess(
        text=user_text,
        attachment_paths=[],   # 或者 ['docs/a.pdf', 'images/b.png']
    )

    user_input = {
        "raw_query": preprocess_result.raw_query,
        "processed_query": preprocess_result.processed_query,
        "attachments": preprocess_result.attachments,
        "preprocess": preprocess_result.model_dump() if hasattr(preprocess_result, "model_dump") else {},
    }

    result = agent.run(user_input)
    print("\n=== Answer ===")
    print(result["answer"])
    print("\n=== Sources ===")
    for i, src in enumerate(result["sources"], 1):
        print(f"[{i}] ({src['source']}, score={src['score']:.3f})")
        # 也可以只打印一小段 content

if __name__ == "__main__":
    run_once()
